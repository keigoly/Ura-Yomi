# コスト上限の仕組みについて

## ⚠️ 重要な理解

**現在の実装では、ユーザー数が1,000人や1万人いても、月額1,000円までに自動的に抑えられるわけではありません。**

## 現在の実装の仕組み

### コスト上限の動作

```
全ユーザーのAPI使用量を合計
  ↓
月間コストを計算
  ↓
1,000円に達したら
  ↓
【新しい解析リクエストを拒否】
```

**つまり：**
- ✅ コストが1,000円を超えないように**制限**する
- ❌ ユーザー数に関係なく1,000円までに**自動的に抑える**わけではない

## 実際のシナリオ

### シナリオ1: ユーザー数が少ない場合

```
ユーザー数: 10人
1人あたり1日5回の解析
  ↓
1日50回の解析
  ↓
月額コスト: 約500円 ✅（1,000円以内）
```

### シナリオ2: ユーザー数が多い場合

```
ユーザー数: 1,000人
1人あたり1日5回の解析
  ↓
1日5,000回の解析
  ↓
月額コスト: 約50,000円 ❌（1,000円を大幅に超過）
  ↓
【しかし、1,000円に達した時点で新しい解析を拒否】
  ↓
実際のコスト: 1,000円 ✅（上限で止まる）
```

**問題点：**
- 1,000円に達したら、それ以降のユーザーは解析できなくなる
- ユーザー数が多いと、すぐに上限に達してしまう

## 解決策

### オプション1: ユーザー数に応じた使用量制限（推奨）

**1ユーザーあたりの使用量を制限**

```javascript
// 1ユーザーあたりの1日の解析回数制限
const DAILY_LIMIT_PER_USER = 3; // 1日3回まで

// 1回あたりのコメント取得上限
const MAX_COMMENTS_PER_ANALYSIS = 2000; // 2,000コメントまで
```

**計算例：**
```
ユーザー数: 1,000人
1人あたり1日3回まで
  ↓
1日最大3,000回の解析
  ↓
各解析2,000コメント
  ↓
YouTube API: 6,000,000ユニット/日
- 無料枠: 10,000ユニット/日
- 有料: 5,990,000ユニット/日 × 0.0015円 = 8,985円/日

月額: 約269,550円 ❌（まだ1,000円を超える）
```

**さらに制限が必要：**
```
ユーザー数: 1,000人
1人あたり1日1回まで（または1週間に5回まで）
  ↓
1日最大1,000回の解析
  ↓
各解析1,000コメントまで
  ↓
YouTube API: 1,000,000ユニット/日
- 無料枠: 10,000ユニット/日
- 有料: 990,000ユニット/日 × 0.0015円 = 1,485円/日

月額: 約44,550円 ❌（まだ1,000円を超える）
```

### オプション2: 無料枠内で運用

**YouTube APIの無料枠を最大限活用**

```
1日10,000ユニットまで無料
  ↓
1回の解析で1,000コメント取得
  ↓
1日最大10回の解析まで無料
  ↓
ユーザー数: 1,000人
1人あたり1日0.01回（月に1回程度）
  ↓
月額コスト: 0円 ✅
```

**問題点：**
- ユーザー数が多いと、1人あたりの使用量が非常に少なくなる

### オプション3: ハイブリッド方式（推奨）

**段階的な制限**

1. **無料枠内で運用**
   - 1日10,000ユニットまで無料
   - これを最大限活用

2. **ユーザー制限**
   - 1ユーザーあたり1日3回まで
   - または1週間に10回まで

3. **コスト上限**
   - 1,000円に達したら新しい解析を拒否
   - ユーザーに通知

4. **優先順位**
   - 有料ユーザーを優先
   - 無料ユーザーは制限を厳しく

## 推奨される設定

### ユーザー数に応じた制限

```javascript
// ユーザー数に応じた1日あたりの解析回数上限
const DAILY_LIMITS = {
  '0-100': 100,      // 100人以下: 1日100回まで
  '101-500': 200,    // 500人以下: 1日200回まで
  '501-1000': 300,   // 1,000人以下: 1日300回まで
  '1001+': 500,      // 1,000人超: 1日500回まで
};

// 1ユーザーあたりの1日の解析回数制限
const PER_USER_DAILY_LIMIT = 3; // 1日3回まで

// 1回あたりのコメント取得上限
const MAX_COMMENTS_PER_ANALYSIS = 2000; // 2,000コメントまで
```

### コスト管理の改善

```javascript
// 月額コスト上限
const MONTHLY_COST_LIMIT = 1000; // 1,000円

// 警告閾値
const WARNING_THRESHOLD = 800; // 800円で警告

// 1ユーザーあたりの月間解析回数制限
const MONTHLY_LIMIT_PER_USER = 30; // 月30回まで
```

## まとめ

**現在の実装：**
- ✅ 月額1,000円のコスト上限を設定
- ✅ 上限に達したら新しい解析を拒否
- ⚠️ **ユーザー数が多いと、すぐに上限に達してしまう**

**推奨される改善：**
1. **1ユーザーあたりの使用量制限**を設定
2. **無料枠を最大限活用**
3. **ユーザー数に応じた制限**を動的に調整
4. **有料ユーザーを優先**する仕組み

**結論：**
- ユーザー数が1,000人や1万人いても、**自動的に1,000円までに抑えられるわけではない**
- ただし、**1,000円に達したら新しい解析を拒否する**ので、**実際のコストは1,000円を超えない**
- ユーザー数が多い場合は、**1ユーザーあたりの使用量を制限する必要がある**

