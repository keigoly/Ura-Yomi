# Google OAuth設定ガイド

このドキュメントでは、YouTubeコメントwithAIで使用するGoogle OAuth認証の設定方法を説明します。

## 概要

YouTubeコメントwithAIでは、ユーザーがGoogleアカウントでサインインできるようにするため、Google OAuth 2.0認証を設定する必要があります。

Chrome拡張機能では、Chrome Identity APIを使用してGoogle認証を行います。この設定により、ユーザーは拡張機能内でGoogleアカウントにサインインできるようになります。

---

## 1. Google Cloud Consoleでの設定

### ステップ1: プロジェクトを作成または選択

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. APIキー設定で使用した**同じプロジェクト**を選択（または新規作成）

### ステップ2: OAuth同意画面を設定

1. 左側のメニューから **「APIとサービス」** → **「OAuth同意画面」** を選択
2. **「外部」** を選択（個人のGoogleアカウントを使用する場合）
3. **「作成」** をクリック

#### アプリ情報を入力

- **アプリ名**: `YouTubeコメントwithAI`（任意の名前）
- **ユーザーサポートメール**: あなたのメールアドレス
- **アプリのロゴ**: 任意（オプション）
- **アプリのホームページ**: 任意（オプション）
- **アプリのプライバシーポリシーリンク**: 任意（オプション）
- **アプリの利用規約リンク**: 任意（オプション）
- **承認済みのドメイン**: 任意（オプション）

4. **「保存して次へ」** をクリック

#### スコープを追加

1. **「スコープを追加または削除」** をクリック
2. 以下のスコープを追加：
   - `openid`
   - `email`
   - `profile`
3. **「更新」** → **「保存して次へ」** をクリック

#### テストユーザーを追加（開発中）

1. **「テストユーザーを追加」** をクリック
2. 自分のGoogleアカウントのメールアドレスを追加
3. **「追加」** → **「保存して次へ」** をクリック

4. **「ダッシュボードに戻る」** をクリック

### ステップ3: OAuth 2.0クライアントIDを作成

1. 左側のメニューから **「APIとサービス」** → **「認証情報」** を選択
2. 画面上部の **「認証情報を作成」** をクリック
3. **「OAuth クライアント ID」** を選択

#### アプリケーションの種類を選択

1. **「アプリケーションの種類」** で **「Chrome アプリ」** を選択
   - ⚠️ **注意**: Chrome拡張機能の場合は「Chrome アプリ」を選択します
2. **「名前」** を入力（例: `YouTubeコメントwithAI Extension`）

#### 拡張機能IDを取得

Chrome拡張機能のIDを取得する必要があります：

1. Chromeブラウザで `chrome://extensions/` を開く
2. **「デベロッパーモード」** を有効にする
3. 拡張機能を読み込む（または既に読み込まれている場合）
4. 拡張機能の下に表示される **「ID」** をコピー
   - 例: `abcdefghijklmnopqrstuvwxyz123456`

#### アプリケーションIDを設定

1. **「アプリケーションID」** フィールドに、コピーした拡張機能IDを貼り付け
2. **「作成」** をクリック

#### クライアントIDとシークレットをコピー

1. **「OAuth クライアントを作成しました」** ダイアログが表示されます
2. **「クライアントID」** をコピー
3. **「クライアントシークレット」** をコピー
4. ⚠️ **重要**: これらの値は秘密情報です。他人に共有しないでください

---

## 2. サーバーへの設定

### ステップ1: `.env`ファイルを編集

`server/.env`ファイルを開き、取得したOAuth認証情報を設定：

```env
# Google OAuth
GOOGLE_CLIENT_ID=123456789-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-abcdefghijklmnopqrstuvwxyz
```

### ステップ2: 拡張機能の設定

プロジェクトルートに`.env`ファイルを作成（または既存のファイルを編集）：

```env
VITE_API_BASE_URL=http://localhost:3000
```

本番環境の場合は：

```env
VITE_API_BASE_URL=https://your-api-server.com
```

---

## 3. Chrome拡張機能のmanifest.jsonの確認

`src/manifest.json`に以下の権限が設定されていることを確認：

```json
{
  "permissions": [
    "identity"
  ]
}
```

既に設定されている場合は、変更不要です。

---

## 4. 認証フローの動作確認

### ステップ1: サーバーを起動

```bash
cd server
npm run dev
```

### ステップ2: 拡張機能をビルド

```bash
npm run build
```

### ステップ3: 拡張機能を読み込む

1. Chromeブラウザで `chrome://extensions/` を開く
2. **「デベロッパーモード」** を有効にする
3. **「パッケージ化されていない拡張機能を読み込む」** をクリック
4. `dist` フォルダを選択

### ステップ4: 認証をテスト

1. YouTube動画ページを開く
2. 拡張機能のアイコンをクリック
3. **「Googleアカウントでサインイン」** をクリック
4. Googleアカウントの選択画面が表示されることを確認
5. アカウントを選択してサインイン
6. 認証が成功し、クレジット残高が表示されることを確認

---

## 5. トラブルシューティング

### 「このアプリは確認されていません」と表示される

- OAuth同意画面で**テストユーザー**として自分のアカウントを追加しているか確認
- アプリが**公開状態**になっているか確認（本番環境の場合）

### 認証エラーが発生する

- `GOOGLE_CLIENT_ID`と`GOOGLE_CLIENT_SECRET`が正しく設定されているか確認
- 拡張機能IDが正しく設定されているか確認
- サーバーが起動しているか確認
- ブラウザのコンソールでエラーメッセージを確認

### リダイレクトエラーが発生する

- Chrome拡張機能のIDが変更されていないか確認
- OAuthクライアントIDの設定で、正しい拡張機能IDが設定されているか確認

### セッションが保持されない

- ローカルストレージが正しく動作しているか確認
- ブラウザの設定でCookieやローカルストレージが無効になっていないか確認

---

## 6. 本番環境への移行

### OAuth同意画面の公開

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. **「APIとサービス」** → **「OAuth同意画面」** を選択
3. **「公開」** をクリック
4. 確認ダイアログで **「公開を確認」** をクリック

⚠️ **注意**: 公開すると、すべてのGoogleアカウントユーザーがアプリを使用できるようになります。

### セキュリティの確認

- OAuthクライアントシークレットが`.env`ファイルに正しく設定されているか
- `.env`ファイルが`.gitignore`に追加されているか
- HTTPSを使用しているか（本番環境）

---

## 7. 次のステップ

Google OAuth認証の設定が完了したら：

1. [APIキー設定ガイド](./API_KEY_SETUP.md) を参照してAPIキーを設定
2. サーバーを起動して動作確認
3. 拡張機能をビルドしてテスト

これで、ユーザーはGoogleアカウントでサインインしてサービスを利用できるようになります。

<!-- Updated -->
