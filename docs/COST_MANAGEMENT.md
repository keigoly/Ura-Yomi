# コスト管理システム

## 概要

月額1,000円程度のコスト上限を設定し、API使用料を管理するシステムです。

## 機能

### 1. コスト追跡

- 月間のAPI使用コストを自動追跡
- YouTube APIとGemini APIの使用料を計算
- 無料枠を考慮したコスト計算

### 2. コスト上限管理

- 月額1,000円の上限を設定
- 上限に達した場合は新しい解析リクエストを拒否
- コスト統計をAPIで取得可能

### 3. 無料枠の活用

**YouTube Data API:**
- 1日10,000ユニットまで無料
- 10,000ユニット超: $0.01/1,000ユニット（約0.0015円/ユニット）

**Gemini API:**
- 無料枠は設定による（要確認）
- 1リクエストあたり約1.5円（概算）

## コスト計算

### 1回の解析あたりのコスト

```
YouTube API:
- コメント取得数に応じたユニット数（概算: 1コメント = 1ユニット）
- 10,000ユニット以内: 無料
- 10,000ユニット超: (ユニット数 - 10,000) × 0.0015円

Gemini API:
- 1リクエストあたり約1.5円（無料枠を超えた場合）

合計コスト = YouTube APIコスト + Gemini APIコスト
```

### 例: 1,000コメントの解析

```
YouTube API: 1,000ユニット → 無料（10,000ユニット以内）
Gemini API: 1リクエスト → 無料枠内なら0円、超えたら1.5円

合計: 0円 または 1.5円
```

### 例: 20,000コメントの解析

```
YouTube API: 20,000ユニット
- 無料枠: 10,000ユニット
- 有料: 10,000ユニット × 0.0015円 = 15円

Gemini API: 1リクエスト → 1.5円

合計: 16.5円
```

## 月額コストの見積もり

### シナリオ1: 無料枠内で運用

```
1日100回の解析（各1,000コメント）
  ↓
YouTube API: 100,000ユニット/日 → 無料枠内（10,000ユニット/日）
Gemini API: 100リクエスト/日 → 無料枠内なら0円
  ↓
月額コスト: 0円 ✅
```

### シナリオ2: 無料枠を超える運用

```
1日500回の解析（各5,000コメント）
  ↓
YouTube API: 2,500,000ユニット/日
- 無料枠: 10,000ユニット/日
- 有料: 2,490,000ユニット/日 × 0.0015円 = 3,735円/日

Gemini API: 500リクエスト/日 → 750円/日（無料枠超えた場合）

合計: 約4,485円/日
月額: 約134,550円 ❌（上限1,000円を大幅に超過）
```

### シナリオ3: 上限内で運用（推奨）

```
1日50回の解析（各2,000コメント）
  ↓
YouTube API: 100,000ユニット/日 → 無料枠内
Gemini API: 50リクエスト/日 → 無料枠内なら0円

月額コスト: 0円 ✅

または

1日30回の解析（各5,000コメント）
  ↓
YouTube API: 150,000ユニット/日
- 無料枠: 10,000ユニット/日
- 有料: 140,000ユニット/日 × 0.0015円 = 210円/日

Gemini API: 30リクエスト/日 → 45円/日

合計: 255円/日
月額: 約7,650円 ❌（上限1,000円を超過）

→ 1日10回程度に制限すれば月額1,000円以内に収まる ✅
```

## コスト管理の推奨設定

### 1. 使用量制限の設定

```javascript
// 1ユーザーあたりの1日の解析回数制限
const DAILY_LIMIT_PER_USER = 10; // 1日10回まで

// 1回あたりのコメント取得上限
const MAX_COMMENTS_PER_ANALYSIS = 2000; // 2,000コメントまで
```

### 2. コスト上限の設定

```javascript
// 月額コスト上限
const MONTHLY_COST_LIMIT = 1000; // 1,000円

// 警告閾値
const WARNING_THRESHOLD = 800; // 800円で警告
```

### 3. アラート設定

- 月額コストが800円に達したら警告
- 月額コストが1,000円に達したら新しい解析を拒否
- 管理者にメール通知（実装が必要）

## API エンドポイント

### コスト統計取得

```bash
GET /api/admin/costs
Authorization: Bearer {ADMIN_SECRET}
```

レスポンス:
```json
{
  "success": true,
  "stats": {
    "month": "2026-02",
    "currentCost": 250.50,
    "limit": 1000,
    "remaining": 749.50,
    "percentage": 25,
    "canProcess": true
  }
}
```

## 運用上の注意

1. **無料枠の監視**
   - 1日10,000ユニットの無料枠を超えないように注意
   - 使用量が多い場合は、1ユーザーあたりの制限を設定

2. **コストの定期確認**
   - 週次でコスト統計を確認
   - 異常な使用がないかチェック

3. **上限到達時の対応**
   - 新しい解析リクエストを拒否
   - ユーザーに通知（実装が必要）
   - 次の月まで待つか、上限を調整

4. **スケーリング**
   - 使用量が増えたら、クレジット価格を調整
   - または、ユーザー制限を強化

## 実装状況

- ✅ コスト計算機能
- ✅ 月額コスト追跡
- ✅ コスト上限チェック
- ✅ 管理者API
- ⚠️ アラート通知（要実装）
- ⚠️ 使用量制限（要実装）
